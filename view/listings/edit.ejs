<% layout("layout/boilerplate") -%>

<!-- üå©Ô∏è Cloudinary Upload Widget -->
<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>

<div class="container mt-5 pt-5 col-lg-10">

  <!-- üîô Back Button -->
  <div class="mb-3">
    <a href="/listings/<%= listing.slug %>" class="btn btn-outline-secondary">
      <i class="fa fa-arrow-left"></i> Back to Listing
    </a>
  </div>

  <!-- üìù Heading -->
  <h2 class="mb-4 text-center fw-bold">‚úèÔ∏è Edit Listing</h2>

  <!-- üßæ Edit Form -->
  <form action="/listings/<%= listing.slug %>?_method=PUT" method="POST">

    <div class="row">

      <!-- Title -->
      <div class="col-md-6 mb-3">
        <label for="title" class="form-label fw-semibold">Title</label>
        <input type="text" class="form-control" id="title" name="listing[title]" value="<%= listing.title %>" required>
      </div>

      <!-- Price -->
      <div class="col-md-6 mb-3">
        <label for="price" class="form-label fw-semibold">Price (INR)</label>
        <input type="number" class="form-control" id="price" name="listing[price]" value="<%= listing.price %>" required>
      </div>

      <!-- Location -->
      <div class="col-md-6 mb-3">
        <label for="location" class="form-label fw-semibold">Location</label>
        <input type="text" class="form-control" id="location" name="listing[location]" value="<%= listing.location %>" required>
      </div>

      <!-- Country -->
      <div class="col-md-6 mb-3">
        <label for="country" class="form-label fw-semibold">Country</label>
        <input type="text" class="form-control" id="country" name="listing[country]" value="<%= listing.country %>" required>
      </div>

      <!-- Category -->
      <div class="col-md-6 mb-3">
        <label for="category" class="form-label fw-semibold">Category</label>
        <select class="form-select" id="category" name="listing[category]" required>
          <% ["Beach", "Mountain", "Lake", "Historic", "Nature", "City", "Sports", "Farm House", "Trending", "OMG", "Experience"].forEach(cat => { %>
            <option value="<%= cat %>" <%= listing.category === cat ? "selected" : "" %>><%= cat %></option>
          <% }) %>
        </select>
      </div>

      <!-- Action Type -->
      <div class="col-md-6 mb-3">
        <label for="actionType" class="form-label fw-semibold">Action Type</label>
        <select class="form-select" id="actionType" name="listing[actionType]" required>
          <% ["book", "reserve", "check", "plan"].forEach(action => { %>
            <option value="<%= action %>" <%= listing.actionType === action ? "selected" : "" %>><%= action.charAt(0).toUpperCase() + action.slice(1) %></option>
          <% }) %>
        </select>
      </div>

    </div>

    <!-- Description -->
    <div class="mb-3">
      <label for="description" class="form-label fw-semibold">Description</label>
      <textarea class="form-control" id="description" rows="4" name="listing[description]" required><%= listing.description %></textarea>
    </div>

    <!-- üñºÔ∏è Current Images -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Current Images</label>
      <div class="d-flex flex-wrap gap-2">
        <% if (listing.images && listing.images.length > 0) { %>
  <% listing.images.forEach((img, index) => { %>
    <div>
      <img src="<%= img %>" alt="Image <%= index + 1 %>" class="rounded shadow-sm" style="height: 100px; object-fit: cover;">
      <input type="text" class="form-control mt-1" name="listing[images][]" value="<%= img %>" />
    </div>
  <% }) %>
<% } else { %>
  <p class="text-muted">No images available.</p>
<% } %>

      </div>
    </div>

    <!-- üì§ Upload More Images -->
    <div class="mb-4">
      <label class="form-label fw-semibold">Add More Images</label><br>
      <button type="button" class="btn btn-outline-primary" id="upload_widget">Upload Images</button>
      <div id="uploaded_images" class="mt-3 d-flex flex-wrap gap-2"></div>
    </div>

    <!-- üöÄ Submit -->
    <div class="text-center">
      <button type="submit" class="btn btn-success px-4 fw-semibold">Update Listing</button>
    </div>
  </form>
</div>

<!-- üß† Cloudinary Upload Script -->
<script>
  const cloudinaryWidget = cloudinary.createUploadWidget({
    cloudName: 'YOUR_CLOUD_NAME',  // üîÅ Replace this
    uploadPreset: 'YOUR_UPLOAD_PRESET',  // üîÅ Replace this
    multiple: true,
    folder: 'wanderlust_uploads'
  }, (error, result) => {
    if (!error && result && result.event === "success") {
      const uploadedImagesDiv = document.getElementById("uploaded_images");
      const input = document.createElement("input");
      input.type = "text";
      input.name = "listing[images][]";
      input.value = result.info.secure_url;
      input.className = "form-control mt-2";
      uploadedImagesDiv.appendChild(input);
    }
  });

  document.getElementById("upload_widget").addEventListener("click", function () {
    cloudinaryWidget.open();
  }, false);
</script>
