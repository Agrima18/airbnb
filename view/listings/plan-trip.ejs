<% layout("/layout/boilerplate") -%>

<div class="container mt-5">

  <!-- Listing Header -->
  <div class="row mb-4">
    <div class="col-md-8">
      <h1 class="display-5"><%= listing.title %></h1>
      <p class="text-muted"><i class="fas fa-map-marker-alt"></i> <%= listing.location %>, <%= listing.country %></p>
    </div>
    <div class="col-md-4 text-end">
      <form action="/wishlist/<%= listing._id %>" method="POST">
        <button class="btn btn-outline-danger">
          <i class="fas fa-heart"></i> Wishlist
        </button>
      </form>
    </div>
  </div>

  <!-- Image Gallery -->
  <div class="row mb-4">
    <div class="col-md-8">
      <img src="<%= listing.image %>" class="img-fluid rounded shadow-sm" alt="<%= listing.title %>">
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm mb-3 p-3">
        <h3 class="h5">Booking</h3>
        <form action="/listings/booking" method="POST">
          <input type="hidden" name="listingId" value="<%= listing._id %>">
          <div class="mb-2">
            <label>Start Date</label>
            <input type="date" name="startDate" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>End Date</label>
            <input type="date" name="endDate" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Guests</label>
            <input type="number" name="guests" class="form-control" min="1" value="1">
          </div>
          <div class="mb-2">
            <label>Total Price</label>
            <input type="number" name="totalPrice" class="form-control" value="<%= listing.price %>">
          </div>
          <button class="btn btn-primary w-100">Book Now</button>
        </form>
      </div>

      <a href="/listings/<%= listing.slug %>/plan-trip" class="btn btn-success w-100 mb-2">
        <i class="fas fa-route"></i> Plan a Trip
      </a>
    </div>
  </div>

  <!-- Listing Description -->
  <div class="row mb-5">
    <div class="col-md-12">
      <h3>Description</h3>
      <p class="lead"><%= listing.description %></p>
      <h5 class="mt-3">Price: $<%= listing.price %> / night</h5>
      <p>Category: <span class="badge bg-info text-dark"><%= listing.category %></span></p>
    </div>
  </div>

  <!-- Tabs for Reviews & Chat -->
  <ul class="nav nav-tabs mb-3" id="listingTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews">Reviews</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat">Chat</button>
    </li>
  </ul>
  <div class="tab-content">
    <!-- Reviews -->
    <div class="tab-pane fade show active" id="reviews">
      <% if (listing.reviews && listing.reviews.length > 0) { %>
        <% listing.reviews.forEach(review => { %>
          <div class="card mb-2 p-2 shadow-sm">
            <strong><%= review.author.username %></strong>
            <p><%= review.body %></p>
            <small class="text-muted"><%= review.createdAt.toDateString() %></small>
          </div>
        <% }) %>
      <% } else { %>
        <p>No reviews yet.</p>
      <% } %>

      <% if (currentUser) { %>
        <form action="/listings/<%= listing.slug %>/reviews" method="POST" class="mt-3">
          <div class="mb-2">
            <textarea name="body" class="form-control" placeholder="Write a review..." required></textarea>
          </div>
          <button class="btn btn-primary">Submit Review</button>
        </form>
      <% } else { %>
        <p><a href="/listings/login">Login</a> to write a review.</p>
      <% } %>
    </div>

    <!-- Chat -->
    <div class="tab-pane fade" id="chat">
      <% if (currentUser) { %>
        <div id="chatBox" class="border p-3 mb-2" style="height:300px; overflow-y:auto;">
          <% messages.forEach(msg => { %>
            <div><strong><%= msg.sender %>:</strong> <%= msg.message %></div>
          <% }) %>
        </div>
        <input type="text" id="chatInput" class="form-control" placeholder="Type a message">
        <button id="chatSend" class="btn btn-success mt-2 w-100">Send</button>
      <% } else { %>
        <p><a href="/listings/login">Login</a> to chat with the host.</p>
      <% } %>
    </div>
  </div>

</div>

<script>
  <% if (currentUser) { %>
    const socket = io();
    const room = "listing-<%= listing._id %>";
    socket.emit("joinRoom", { room });

    document.getElementById("chatSend").addEventListener("click", () => {
      const msg = document.getElementById("chatInput").value;
      if(msg.trim() === '') return;
      socket.emit("sendMessage", { room, message: msg, sender: "<%= currentUser.username %>" });
      document.getElementById("chatInput").value = '';
    });

    socket.on("receiveMessage", data => {
      const chatBox = document.getElementById("chatBox");
      const div = document.createElement("div");
      div.innerHTML = "<strong>" + data.sender + ":</strong> " + data.message;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  <% } %>
</script>

 


